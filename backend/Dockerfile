FROM node:22-bullseye AS build

WORKDIR /app

# Copy environment variables
ARG DATABASE_URL
ENV DATABASE_URL=$DATABASE_URL
ARG BARCODE_API_KEY
ENV BARCODE_API_KEY=$BARCODE_API_KEY
ARG AI_API_KEY
ENV AI_API_KEY=$AI_API_KEY
ARG GOOGLE_API_KEY
ENV GOOGLE_API_KEY=$GOOGLE_API_KEY
ARG GOOGLE_SEARCH_KEY
ENV GOOGLE_SEARCH_KEY=$GOOGLE_SEARCH_KEY
ARG CORPWATCH_API_KEY
ENV CORPWATCH_API_KEY=$CORPWATCH_API_KEY

# Set base variables
ENV NODE_ENV=production
ENV LOG_LEVEL=info
ENV API_HOST=::
ENV API_PORT=8000
EXPOSE ${API_PORT}

# Copy files
COPY . .

# Enable corepack
RUN corepack enable

# Install
RUN yarn install --frozen-lockfile --immutable
RUN yarn prebuild
RUN yarn build

# Run
CMD [ "yarn", "start" ]
